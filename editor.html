<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blog Editor</title>
  <style>
    /* Add your styles here for forms, etc. */
    .post-list { margin-top:2em; }
    .user-list { margin-top:2em; }
  </style>
</head>
<body>
  <h1>Blog Editor</h1>
  <div id="profile"></div>
  <button id="sign-in-btn">Sign In</button>
  <button id="sign-out-btn" style="display:none;">Sign Out</button>

  <h2>Posts</h2>
  <button id="add-post-btn">Add Post</button>
  <div class="post-list" id="post-list"></div>

  <h2>Users</h2>
  <button id="add-user-btn">Add User</button>
  <div class="user-list" id="user-list"></div>

  <div id="modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;">
    <div style="background:#fff;padding:2em;max-width:400px;margin:auto;">
      <span id="modal-close" style="float:right;cursor:pointer;">&times;</span>
      <div id="modal-content"></div>
    </div>
  </div>

<script>
let blog = { title: "", posts: [] };
let users = [];
let signedInUser = null;

let sessionId = localStorage.getItem('sessionId');
if (!sessionId) {
  sessionId = Math.random().toString(36).slice(2);
  localStorage.setItem('sessionId', sessionId);
}

function fetchWithSession(url, opts = {}) {
  opts.headers = opts.headers || {};
  opts.headers['x-session-id'] = sessionId;
  return fetch(url, opts);
}

async function loadBlogAndUsers() {
  const [blogRes, usersRes, userRes] = await Promise.all([
    fetchWithSession('/api/blog'),
    fetchWithSession('/api/users'),
    fetchWithSession('/api/currentUser')
  ]);
  blog = await blogRes.json();
  users = await usersRes.json();
  const userData = await userRes.json();
  signedInUser = userData.user;
  updateProfile();
  renderPosts();
  renderUsers();
}
window.onload = loadBlogAndUsers;

function updateProfile() {
  document.getElementById('profile').textContent = signedInUser ? ('Signed in as: ' + signedInUser) : 'Not signed in';
  document.getElementById('sign-in-btn').style.display = signedInUser ? 'none' : '';
  document.getElementById('sign-out-btn').style.display = signedInUser ? '' : 'none';
}

document.getElementById('sign-in-btn').onclick = function() {
  showModal('Sign In', getSignInForm());
};
document.getElementById('sign-out-btn').onclick = async function() {
  await fetchWithSession('/api/currentUser', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ user: null })
  });
  signedInUser = null;
  updateProfile();
};

function getSignInForm() {
  let html = '<select id="signin-user">';
  users.forEach(u => {
    html += `<option value="${u.name}">${u.name} (${u.role})</option>`;
  });
  html += '</select> <button id="do-signin">Sign In</button>';
  setTimeout(() => {
    document.getElementById('do-signin').onclick = async function() {
      const username = document.getElementById('signin-user').value;
      await setCurrentUser(username);
      closeModal();
      updateProfile();
    };
  }, 0);
  return html;
}

async function setCurrentUser(username) {
  await fetchWithSession('/api/currentUser', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ user: username })
  });
  signedInUser = username;
}

document.getElementById('add-post-btn').onclick = function() {
  if (!signedInUser) return showModal('Error', 'You must sign in.');
  showModal('Add Post', getPostForm());
};
function getPostForm(post = {}) {
  let html = `
    <form id="post-form">
      <input type="text" id="post-title" placeholder="Title" value="${post.title || ''}" required><br>
      <input type="date" id="post-date" value="${post.date || ''}" required><br>
      <input type="text" id="post-tags" placeholder="Tags (comma separated)" value="${post.tags ? post.tags.join(', ') : ''}"><br>
      <input type="text" id="post-type" placeholder="Type" value="${post.type || ''}" required><br>
      <textarea id="post-content" placeholder="Content" required>${post.content || ''}</textarea><br>
      <button type="submit">Save</button>
    </form>
  `;
  setTimeout(() => {
    document.getElementById('post-form').onsubmit = async function(e) {
      e.preventDefault();
      const newPost = {
        title: document.getElementById('post-title').value,
        date: document.getElementById('post-date').value,
        tags: document.getElementById('post-tags').value.split(',').map(s=>s.trim()).filter(Boolean),
        type: document.getElementById('post-type').value,
        content: document.getElementById('post-content').value,
        author: signedInUser,
        editors: []
      };
      await addPost(newPost);
      closeModal();
      renderPosts();
    };
  }, 0);
  return html;
}
async function addPost(post) {
  const res = await fetchWithSession('/api/posts', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(post)
  });
  const saved = await res.json();
  blog.posts.push(saved);
}

function renderPosts() {
  const div = document.getElementById('post-list');
  div.innerHTML = '';
  blog.posts.forEach((post, idx) => {
    const d = document.createElement('div');
    d.innerHTML = `<b>${post.title}</b> by ${post.author} (${post.date}) <button data-idx="${idx}">Edit</button>`;
    d.querySelector('button').onclick = function() {
      if (!signedInUser) return showModal('Error', 'You must sign in.');
      if (post.author !== signedInUser && !(post.editors||[]).includes(signedInUser)) {
        return showModal('Error', 'You do not have permission to edit this post.');
      }
      showModal('Edit Post', getPostForm(post, idx));
      setTimeout(() => {
        document.getElementById('post-form').onsubmit = async function(e) {
          e.preventDefault();
          post.title = document.getElementById('post-title').value;
          post.date = document.getElementById('post-date').value;
          post.tags = document.getElementById('post-tags').value.split(',').map(s=>s.trim()).filter(Boolean);
          post.type = document.getElementById('post-type').value;
          post.content = document.getElementById('post-content').value;
          await editPost(idx, post);
          closeModal();
          renderPosts();
        };
      }, 0);
    };
    div.appendChild(d);
  });
}
async function editPost(idx, updated) {
  const res = await fetchWithSession(`/api/posts/${idx}`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(updated)
  });
  blog.posts[idx] = await res.json();
}

document.getElementById('add-user-btn').onclick = function() {
  showModal('Add User', getUserForm());
};
function getUserForm() {
  let html = `
    <form id="user-form">
      <input type="text" id="user-name" placeholder="Username" required><br>
      <select id="user-role">
        <option value="author">Author</option>
        <option value="admin">Admin</option>
      </select><br>
      <button type="submit">Save</button>
    </form>
  `;
  setTimeout(() => {
    document.getElementById('user-form').onsubmit = async function(e) {
      e.preventDefault();
      const newUser = {
        name: document.getElementById('user-name').value,
        role: document.getElementById('user-role').value
      };
      await addUser(newUser);
      closeModal();
      renderUsers();
    };
  }, 0);
  return html;
}
async function addUser(user) {
  const res = await fetchWithSession('/api/users', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(user)
  });
  const saved = await res.json();
  users.push(saved);
}
function renderUsers() {
  const div = document.getElementById('user-list');
  div.innerHTML = '';
  users.forEach((user, idx) => {
    div.innerHTML += `<div>${user.name} (${user.role})</div>`;
  });
}

// Modal helpers
function showModal(title, content) {
  document.getElementById('modal-content').innerHTML = `<h3>${title}</h3>${content}`;
  document.getElementById('modal').style.display = 'flex';
}
function closeModal() {
  document.getElementById('modal').style.display = 'none';
}
document.getElementById('modal-close').onclick = closeModal;
</script>
</body>
</html>
